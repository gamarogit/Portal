generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- CORE MODELS (Gateway) ---

model User {
  id                     String              @id @default(uuid())
  email                  String              @unique
  password               String
  name                   String
  roleId                 String
  role                   Role                @relation(fields: [roleId], references: [id])
  active                 Boolean             @default(true)
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt

  // Relations from Activos
  assets                 Asset[]             @relation("Responsible")
  requestedMovements     Movement[]          @relation("requestedBy")
  approvedMovements      Movement[]          @relation("approvedBy")
  maintenances           Maintenance[]       @relation("performedBy")
  depreciations          Depreciation[]      @relation("recordedBy")
  auditLogs              AuditLog[]          @relation("performedBy")
  licenseAssignments     LicenseAssignment[]
  customReports          CustomReport[]
  
  // Permissions
  systemPermissions      SystemPermission[]
  featurePermissions     FeaturePermission[]
  
  // Inventory
  stockMovements         StockMovement[]
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  users       User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PortalSystem {
  id          String   @id @default(uuid())
  name        String   @unique
  description String
  icon        String   @default("")
  route       String   // Puede ser ruta interna o URL a microservicio
  apiUrl      String?  // URL del backend del microservicio
  color       String   @default("#667eea")
  enabled     Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Permissions
  systemPermissions SystemPermission[]
  features          SystemFeature[]
}

model ThemeConfig {
  id             String   @id @default(uuid())
  primaryColor   String   @default("#003b4d")
  secondaryColor String   @default("#00afaa")
  accentColor    String   @default("#d9c79e")
  backgroundColor String  @default("#f0f2f5")
  fontFamily     String   @default("Montserrat")
  logoUrl        String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// --- ACTIVOS MODELS ---

enum AssetState {
  ACTIVO
  MANTENIMIENTO
  DADO_DE_BAJA
  TRANSFERIDO
  CUARENTENA
}

enum MovementType {
  ALTA
  BAJA
  TRASLADO
}

enum MovementStatus {
  PENDIENTE
  EN_CURSO
  REALIZADO
  CANCELADO
}

enum MaintenanceStatus {
  PROGRAMADO
  EN_PROGRESO
  COMPLETADO
  CANCELADO
}

enum LicenseStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  SUSPENDED
}

model AssetType {
  id          String  @id @default(uuid())
  name        String  @unique
  description String?
  assets      Asset[]
}

model Location {
  id           String     @id @default(uuid())
  name         String
  type         String
  description  String?
  assets       Asset[]
  movementsFrom Movement[] @relation("fromLocation")
  movementsTo   Movement[] @relation("toLocation")
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model Asset {
  id                 String              @id @default(uuid())
  name               String
  serialNumber       String?             @unique
  manufacturer       String?
  model              String?
  operatingSystem    String?
  assetTypeId        String?
  assetType          AssetType?          @relation(fields: [assetTypeId], references: [id])
  locationId         String?
  location           Location?           @relation(fields: [locationId], references: [id])
  responsibleId      String?
  responsible        User?               @relation("Responsible", fields: [responsibleId], references: [id])
  vendorId           String?
  vendor             Vendor?             @relation(fields: [vendorId], references: [id])
  contractId         String?
  contract           MaintenanceContract? @relation("ContractAssets", fields: [contractId], references: [id])
  state              AssetState          @default(ACTIVO)
  purchaseDate       DateTime?
  warrantyUntil      DateTime?
  cost               Decimal?            @db.Decimal(12, 2)
  notes              String?
  movements          Movement[]
  maintenances       Maintenance[]
  attachments        Attachment[]
  depreciations      Depreciation[]
  audits             AuditLog[]          @relation("AssetsAudit")
  licenseAssignments LicenseAssignment[]
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  code               String?             @unique
  specs              Json?
}

model Movement {
  id             String         @id @default(uuid())
  folio          String         @unique
  assetId        String
  asset          Asset          @relation(fields: [assetId], references: [id])
  movementType   MovementType
  fromLocationId String?
  fromLocation   Location?    @relation("fromLocation", fields: [fromLocationId], references: [id])
  toLocationId   String?
  toLocation     Location?    @relation("toLocation", fields: [toLocationId], references: [id])
  requestedById  String?
  requestedBy    User?        @relation("requestedBy", fields: [requestedById], references: [id])
  approvedById   String?
  approvedBy     User?        @relation("approvedBy", fields: [approvedById], references: [id])
  scheduledAt    DateTime?
  completedAt    DateTime?
  status         MovementStatus @default(PENDIENTE)
  reason         String?
  notes          String?
  attachments    Attachment[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model Maintenance {
  id              String               @id @default(uuid())
  assetId         String
  asset           Asset                @relation(fields: [assetId], references: [id])
  maintenanceType String
  description     String?
  scheduledAt     DateTime
  completedAt     DateTime?
  executedAt      DateTime?
  status          MaintenanceStatus    @default(PROGRAMADO)
  cost            Decimal?             @db.Decimal(12, 2)
  performedById   String?
  performedBy     User?                @relation("performedBy", fields: [performedById], references: [id])
  contractId      String?
  contract        MaintenanceContract? @relation(fields: [contractId], references: [id])
  provider        String?
  notes           String?
  attachments     Attachment[]
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
}

model Attachment {
  id            String      @id @default(uuid())
  assetId       String?
  asset         Asset?      @relation(fields: [assetId], references: [id])
  movementId    String?
  movement      Movement?   @relation(fields: [movementId], references: [id])
  maintenanceId String?
  maintenance   Maintenance? @relation(fields: [maintenanceId], references: [id])
  fileName      String
  mimeType      String?
  url           String
  metadata      Json?
  createdAt     DateTime     @default(now())
}

model Depreciation {
  id           String   @id @default(uuid())
  assetId      String
  asset        Asset    @relation(fields: [assetId], references: [id])
  periodStart  DateTime
  periodEnd    DateTime
  amount       Decimal  @db.Decimal(12, 2)
  method       String
  recordedById String?
  recordedBy   User?    @relation("recordedBy", fields: [recordedById], references: [id])
  notes        String?
  createdAt    DateTime @default(now())
}

model AuditLog {
  id            String   @id @default(uuid())
  entity        String
  entityId      String
  action        String
  changes       Json
  performedById String?
  performedBy   User?    @relation("performedBy", fields: [performedById], references: [id])
  assetId       String?
  asset         Asset?   @relation("AssetsAudit", fields: [assetId], references: [id])
  occurredAt    DateTime @default(now())
}

model IntegrationEvent {
  id              String   @id @default(uuid())
  source          String
  payload         Json
  status          String   @default("PENDING")
  lastAttemptedAt DateTime?
  createdAt       DateTime @default(now())
}

model License {
  id              String              @id @default(uuid())
  name            String
  vendor          String
  licenseKey      String?
  purchaseDate    DateTime
  expirationDate  DateTime?
  totalSeats      Int                 @default(1)
  usedSeats       Int                 @default(0)
  unitCost        Decimal?            @db.Decimal(12, 2)
  totalCost       Decimal?            @db.Decimal(12, 2)
  invoiceFolio    String?
  contractNumber  String?
  status          LicenseStatus       @default(ACTIVE)
  notes           String?
  assignments     LicenseAssignment[]
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
}

model LicenseAssignment {
  id          String    @id @default(uuid())
  licenseId   String
  license     License   @relation(fields: [licenseId], references: [id], onDelete: Cascade)
  userId      String?
  user        User?     @relation(fields: [userId], references: [id])
  assetId     String?
  asset       Asset?    @relation(fields: [assetId], references: [id])
  assignedAt  DateTime  @default(now())
  notes       String?
  createdAt   DateTime  @default(now())
}

model Vendor {
  id              String                @id @default(uuid())
  name            String                @unique
  contactName     String?
  email           String?
  phone           String?
  website         String?
  address         String?
  rating          Int?
  notes           String?
  assets          Asset[]
  contracts       MaintenanceContract[]
  products        Product[]             // Productos que tienen este vendor como proveedor preferido
  purchaseOrders  PurchaseOrder[]       // rdenes de compra a este proveedor
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
}

model MaintenanceContract {
  id           String        @id @default(uuid())
  vendorId     String
  vendor       Vendor        @relation(fields: [vendorId], references: [id])
  name         String
  startDate    DateTime
  endDate      DateTime
  cost         Decimal       @db.Decimal(12, 2)
  scope        String?
  sla          Json?
  assets       Asset[]       @relation("ContractAssets")
  maintenances Maintenance[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model CustomReport {
  id          String   @id @default(uuid())
  title       String
  description String?
  content     String   @db.Text
  createdBy   String
  creator     User     @relation(fields: [createdBy], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model FormConfig {
  id        String   @id @default(uuid())
  formName  String   @unique
  config    Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- PERMISSIONS MODELS ---

model SystemPermission {
  id        String       @id @default(uuid())
  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  systemId  String
  system    PortalSystem @relation(fields: [systemId], references: [id], onDelete: Cascade)
  canAccess Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@unique([userId, systemId])
}

model SystemFeature {
  id          String              @id @default(uuid())
  systemId    String
  system      PortalSystem        @relation(fields: [systemId], references: [id], onDelete: Cascade)
  key         String              // ej: "assets.create", "assets.delete"
  name        String              // ej: "Crear activos", "Eliminar activos"
  description String?
  category    String?             // ej: "Activos", "Reportes"
  permissions FeaturePermission[]
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@unique([systemId, key])
}

model FeaturePermission {
  id        String        @id @default(uuid())
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  featureId String
  feature   SystemFeature @relation(fields: [featureId], references: [id], onDelete: Cascade)
  granted   Boolean       @default(true)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@unique([userId, featureId])
}

// --- INVENTORY MODELS ---

enum StockMovementType {
  ENTRADA
  SALIDA
  AJUSTE
}

enum AlertType {
  LOW_STOCK
  OUT_OF_STOCK
  OVERSTOCK
}

model Product {
  id                    String             @id @default(uuid())
  sku                   String             @unique
  name                  String
  description           String?
  category              String?
  unit                  String             @default("unidad") // unidad, kg, litro, etc.
  currentStock          Int                @default(0)
  minStock              Int                @default(0)
  maxStock              Int?
  reorderPoint          Int?               // Punto de reorden
  optimalOrderQuantity  Int?               // Cantidad 贸ptima de compra
  unitCost              Decimal?           @db.Decimal(12, 2)
  location              String?            // Ubicaci贸n en almac茅n
  preferredSupplierId   String?            // Proveedor preferido
  preferredSupplier     Vendor?            @relation(fields: [preferredSupplierId], references: [id])
  active                Boolean            @default(true)
  movements             StockMovement[]
  alerts                StockAlert[]
  reorderAlerts         ReorderAlert[]
  purchaseOrderItems    PurchaseOrderItem[]
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
}

model StockMovement {
  id            String            @id @default(uuid())
  productId     String
  product       Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
  type          StockMovementType
  quantity      Int
  previousStock Int
  newStock      Int
  reason        String?           // Compra, Venta, Devoluci贸n, Merma, etc.
  reference     String?           // N煤mero de pedido, factura, etc.
  notes         String?
  userId        String
  user          User              @relation(fields: [userId], references: [id])
  createdAt     DateTime          @default(now())
}

model StockAlert {
  id           String    @id @default(uuid())
  productId    String
  product      Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  type         AlertType @default(LOW_STOCK)
  message      String
  currentStock Int
  minStock     Int
  resolved     Boolean   @default(false)
  resolvedAt   DateTime?
  resolvedBy   String?
  createdAt    DateTime  @default(now())
}

// --- PURCHASE ORDER MODELS ---

enum ReorderAlertStatus {
  PENDING
  ORDERED
  RESOLVED
  IGNORED
}

enum PurchaseOrderStatus {
  DRAFT
  SENT
  RECEIVED
  CANCELLED
}

model ReorderAlert {
  id                String             @id @default(uuid())
  productId         String
  product           Product            @relation(fields: [productId], references: [id], onDelete: Cascade)
  currentStock      Int
  reorderPoint      Int
  suggestedQuantity Int
  status            ReorderAlertStatus @default(PENDING)
  purchaseOrderId   String?
  purchaseOrder     PurchaseOrder?     @relation(fields: [purchaseOrderId], references: [id])
  createdAt         DateTime           @default(now())
  resolvedAt        DateTime?
  notes             String?
}

model PurchaseOrder {
  id              String              @id @default(uuid())
  orderNumber     String              @unique
  supplierId      String
  supplier        Vendor              @relation(fields: [supplierId], references: [id])
  status          PurchaseOrderStatus @default(DRAFT)
  orderDate       DateTime            @default(now())
  expectedDate    DateTime?
  receivedDate    DateTime?
  items           PurchaseOrderItem[]
  reorderAlerts   ReorderAlert[]
  totalAmount     Decimal?            @db.Decimal(12, 2)
  notes           String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  productId       String
  product         Product       @relation(fields: [productId], references: [id])
  quantity        Int
  unitCost        Decimal       @db.Decimal(12, 2)
  subtotal        Decimal       @db.Decimal(12, 2)
  receivedQty     Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}


// --- NOTIFICATION MODELS ---

enum NotificationType {
  ALERT
  APPROVAL
  INFO
}

enum NotificationPriority {
  HIGH
  MEDIUM
  LOW
}

model Notification {
  id        String               @id @default(uuid())
  userId    String?              // Opcional: si es para un usuario espec铆fico
  role      String?              // Opcional: si es para un rol (ej. ADMIN)
  type      NotificationType
  title     String
  message   String
  priority  NotificationPriority
  link      String?              // Ruta a la acci贸n
  isRead    Boolean              @default(false)
  createdAt DateTime             @default(now())
  
  // Relaci贸n polim贸rfica simplificada (referencias por ID)
  sourceId   String? // ID del objeto relacionado (ReorderAlert.id, PurchaseOrder.id)
  sourceType String? // REORDER_ALERT, PURCHASE_ORDER
}
